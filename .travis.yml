sudo: false
language: python
python: 3.6

cache: pip

install: pip install tox

script: tox -v

jobs:
  include:
  - env: TOXENV=lint

  - python: 3.5
    env: TOXENV=py35

  - python: 3.6
    env: TOXENV=py36

  - python: 3.7
    dist: xenial
    sudo: required
    env: TOXENV=py37

  - python: pypy3.5
    env: TOXENV=pypy3

  - stage: deploy
    name: Github Releases
    install: skip
    script: python setup.py sdist bdist_wheel
    deploy:
      provider: releases
      api_key: $GITHUB_OAUTH_TOKEN
      file_glob: true
      file: dist/*
      skip_cleanup: true

  - name: PyPI
    install: skip
    script: skip
    deploy:
      provider: pypi
      user: $PYPI_USER
      password: $PYPI_PASSWORD
      distributions: sdist bdist_wheel
      skip_existing: true

stages:
  - test
  - name: deploy
    if: branch = master AND tag IS present

after_failure:
- more .tox/log/* | cat
- more .tox/*/log/* | cat
